DELIMITER $$

DROP PROCEDURE IF EXISTS `pontuacao_development`.`calcula_pontuacao`$$
CREATE DEFINER=`root`@`localhost` PROCEDURE `calcula_pontuacao`(IN pid INT)
BEGIN
   
   DECLARE $dias_ant INT;
   DECLARE $dias_at INT;
   DECLARE $unidade_ant INT;
   DECLARE $unidade_at INT;
   DECLARE $outro_trab_ant INT;
   DECLARE $outro_trab_at INT;
   DECLARE $f_abonada_ant INT;
   DECLARE $f_abonada_at INT;
   DECLARE $atestado_ant INT;
   DECLARE $atestado_at INT;
   DECLARE $f_justif_ant INT;
   DECLARE $f_justif_at INT;
   DECLARE $f_injustif_ant INT;
   DECLARE $f_injustif_at INT;
   DECLARE $lic_saude_ant INT; 
   DECLARE $lic_saude_at INT;
   DECLARE $afastamento_ant INT;
   DECLARE $afastamento_at INT;
   DECLARE $ano_ant INT;
   DECLARE $ano_at INT;
   DECLARE $f_abonada_atual INT;
   DECLARE $atestado_atual INT;
   DECLARE $lic_saude_atual INT;
   DECLARE $dias_trab_atual INT;
   DECLARE $f_abonada_anterior INT;
   DECLARE $atestado_anterior INT;
   DECLARE $lic_saude_anterior INT;
   DECLARE $dias_trab_anterior INT;
   DECLARE $de_ant DECIMAL(10,3);
   DECLARE $de_at DECIMAL(10,3);

	select ano into $ano_ant from trabalhados where ano = (year(curdate()) -1) and professor_id = pid and flag = 0 and ano_letivo = year(curdate());
	select ano into $ano_at from trabalhados where ano = year(curdate()) and professor_id = pid and flag = 0 and ano_letivo = year(curdate());
	select dias into $dias_ant from trabalhados where ano = (year(curdate()) -1) and professor_id = pid and flag = 0 and ano_letivo = year(curdate());
	select dias into $dias_at from trabalhados where ano = year(curdate()) and professor_id = pid and flag = 0 and ano_letivo = year(curdate());
	select unidade into $unidade_ant from trabalhados where ano = (year(curdate()) -1) and professor_id = pid and flag = 0 and ano_letivo = year(curdate());
	select unidade into $unidade_at from trabalhados where ano = year(curdate()) and professor_id = pid and flag = 0 and ano_letivo = year(curdate());
	select outro_trab into $outro_trab_ant from trabalhados where ano = (year(curdate()-1)) and professor_id = pid and flag = 0 and ano_letivo = year(curdate());
	select outro_trab into $outro_trab_at from trabalhados where ano = year(curdate()) and professor_id = pid and flag = 0 and ano_letivo = year(curdate());	
	select f_abonada into $f_abonada_ant from trabalhados where ano = (year(curdate()) -1) and professor_id = pid and flag = 0 and ano_letivo = year(curdate());
	select f_abonada into $f_abonada_at from trabalhados where ano = year(curdate()) and professor_id = pid and flag = 0 and ano_letivo = year(curdate());
	select atestado into $atestado_ant from trabalhados where ano = (year(curdate()) -1) and professor_id = pid and flag = 0 and ano_letivo = year(curdate());
	select atestado into $atestado_at from trabalhados where ano = year(curdate()) and professor_id = pid and flag = 0 and ano_letivo = year(curdate());
	select f_justif into $f_justif_ant from trabalhados where ano = (year(curdate()) -1) and professor_id = pid and flag = 0 and ano_letivo = year(curdate());
	select f_justif into $f_justif_at from trabalhados where ano = year(curdate()) and professor_id = pid and flag = 0 and ano_letivo = year(curdate());
	select f_injustif into $f_injustif_ant from trabalhados where ano = (year(curdate()) -1) and professor_id = pid and flag = 0 and ano_letivo = year(curdate());
	select f_injustif into $f_injustif_at from trabalhados where ano = year(curdate()) and professor_id = pid and flag = 0 and ano_letivo = year(curdate());
	select afastamento into $afastamento_ant from trabalhados where ano = (year(curdate()) -1) and professor_id = pid and flag = 0 and ano_letivo = year(curdate());
	select afastamento into $afastamento_at from trabalhados where ano = year(curdate()) and professor_id = pid and flag = 0 and ano_letivo = year(curdate());
	select atestado into $atestado_ant from trabalhados where ano = (year(curdate()) -1) and professor_id = pid and flag = 0 and ano_letivo = year(curdate());
	select atestado into $atestado_at from trabalhados where ano = year(curdate()) and professor_id = pid and flag = 0 and ano_letivo = year(curdate());
	select lic_saude into $lic_saude_ant from trabalhados where ano = (year(curdate()) -1) and professor_id = pid and flag = 0 and ano_letivo = year(curdate());
	select lic_saude into $lic_saude_at from trabalhados where ano = year(curdate()) and professor_id = pid and flag = 0 and ano_letivo = year(curdate());
	


	UPDATE trabalhados SET dias_trab = ($dias_ant - ($f_abonada_ant + $atestado_ant + $f_justif_ant + $f_injustif_ant + $lic_saude_ant + $afastamento_ant)) where professor_id = pid and ano = (year(curdate()) -1) and ano_letivo = year(curdate());
	UPDATE trabalhados SET dias_trab = ($dias_at - ($f_abonada_at + $atestado_at + $f_justif_at + $f_injustif_at + $lic_saude_at + $afastamento_at)) where professor_id = pid and ano = year(curdate()) and ano_letivo = year(curdate());
	IF $unidade_ant = 0 then
		UPDATE trabalhados SET dias_unidade = 0 where professor_id = pid and ano = (year(curdate())-1) and ano_letivo = year(curdate());
	else
		UPDATE trabalhados SET dias_unidade = $unidade_ant - ($f_abonada_ant + $atestado_ant + $f_justif_ant + $f_injustif_ant + $lic_saude_ant) where professor_id = pid and ano = (year(curdate())-1) and ano_letivo = year(curdate());
	end if;

	IF $unidade_at = 0 then
		UPDATE trabalhados SET dias_unidade = 0 where professor_id = pid and ano = year(curdate()) and ano_letivo = year(curdate());
	else
		UPDATE trabalhados SET dias_unidade = $unidade_at - ($f_abonada_at + $atestado_at + $f_justif_at + $f_injustif_at + $lic_saude_at) where professor_id = pid and ano = year(curdate()) and ano_letivo = year(curdate());	
	end if;

	UPDATE trabalhados SET dias_rede = $dias_ant + $outro_trab_ant where professor_id = pid and ano = (year(curdate()) -1) and ano_letivo = year(curdate());
	UPDATE trabalhados SET dias_rede = $dias_at + $outro_trab_at where professor_id = pid and ano = year(curdate()) and ano_letivo = year(curdate());

	IF $ano_ant = (year(curdate()) -1) THEN
		SELECT f_abonada into $f_abonada_atual from trabalhados where professor_id = pid and ano = ($ano_ant + 1) and ano_letivo = year(curdate()) and ano_letivo = year(curdate());
		SELECT atestado into $atestado_atual from trabalhados where professor_id = pid and ano = ($ano_ant + 1) and ano_letivo = year(curdate()) and ano_letivo = year(curdate());	
		SELECT lic_saude into $lic_saude_atual from trabalhados where professor_id = pid and ano = ($ano_ant  + 1) and ano_letivo = year(curdate()) and ano_letivo = year(curdate());
		SELECT dias_trab into $dias_trab_atual from trabalhados where professor_id = pid and ano = ($ano_ant + 1) and ano_letivo = year(curdate()) and ano_letivo = year(curdate());
		SET $de_ant = (($f_abonada_ant + $f_abonada_atual) + ($atestado_ant + $atestado_atual) + ($lic_saude_ant + $lic_saude_atual)); 
		IF $de_ant <= 15 then
			UPDATE trabalhados SET dias_efetivos = $dias_ant - ($f_justif_ant + $f_injustif_ant + $afastamento_ant) where professor_id = pid and ano = (year(curdate()) -1) and ano_letivo = year(curdate());
		ELSE
			UPDATE trabalhados SET dias_efetivos = $dias_ant - ($f_abonada_ant + $atestado_ant + $lic_saude_ant + $f_justif_ant + $f_injustif_ant + $afastamento_ant) where professor_id = pid and ano = (year(curdate()) -1) and ano_letivo = year(curdate());
		END IF;
	END IF;


	IF $ano_at = year(curdate()) THEN
		SELECT f_abonada into $f_abonada_anterior from trabalhados where professor_id = pid and ano = ($ano_at - 1) and ano_letivo = year(curdate());
		SELECT atestado into $atestado_anterior from trabalhados where professor_id = pid and ano = ($ano_at - 1) and ano_letivo = year(curdate());
		SELECT lic_saude into $lic_saude_anterior from trabalhados where professor_id = pid and ano = ($ano_at  - 1) and ano_letivo = year(curdate());
		SELECT dias_trab into $dias_trab_anterior from trabalhados where professor_id = pid and ano = ($ano_at - 1) and ano_letivo = year(curdate());
		SET $de_at = (($f_abonada_at + $f_abonada_anterior) + ($atestado_at + $atestado_anterior) + ($lic_saude_at + $lic_saude_anterior)); 
		IF $de_at <= 15 then
			UPDATE trabalhados SET dias_efetivos = $dias_at - ($f_justif_at + $f_injustif_at + $afastamento_at) where professor_id = pid and ano = year(curdate()) and ano_letivo = year(curdate());
		ELSE
			UPDATE trabalhados SET dias_efetivos = $dias_at - ($f_abonada_at + $atestado_at + $lic_saude_at + $f_justif_at + $f_injustif_at + $afastamento_at) where professor_id = pid and ano = year(curdate()) and ano_letivo = year(curdate());
		END IF;

	end if;









END$$

DELIMITER ;

