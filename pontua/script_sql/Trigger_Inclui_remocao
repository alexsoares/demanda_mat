drop trigger if exists remocao_professor;
delimiter $$
 CREATE TRIGGER remocao_professor
     BEFORE INSERT ON remocaos
     FOR EACH ROW
    BEGIN

	IF new.remocao = 1 then
		SELECT valor_unid into @new_valor from acum_trabs where professor_id = new.professor_id;
		SET new.valor_unid = @new_valor;
		SELECT unidade into @new_unidade_ant from trabalhados where professor_id = new.professor_id and ano = (year(curdate())-1) and ano_letivo = year(curdate()) order by id desc limit 1;
		IF @new_unidade_ant <> null THEN
			SET new.unidade_ant = 0;
		ELSE
			SET new.unidade_ant = @new_unidade_ant;
		END IF;

		SELECT unidade into @new_unidade_atual from trabalhados where professor_id = new.professor_id and ano = (year(curdate())) and ano_letivo = year(curdate()) order by id limit 1;
		IF @new_unidade_atual <> null THEN
			SET new.unidade_atual = 0;
		ELSE
			SET new.unidade_atual = @new_unidade_atual;
		END IF;

		UPDATE trabalhados SET unidade = 0 where professor_id = new.professor_id and ano_letivo = year(curdate());
		UPDATE acum_trabs SET verifica = 2 where professor_id = new.professor_id;
		UPDATE acum_trabs SET valor_unid = 0 where professor_id = new.professor_id;

		SELECT tot_acum_unid into @tvu from acum_trabs where professor_id = new.professor_id;
		SET NEW.tot_acum_unid = @tvu;
		SELECT tot_geral_unid into @tgu from acum_trabs where professor_id = new.professor_id;
		SET NEW.tot_geral_unid = @tgu;

		update acum_trabs set tot_geral_unid = 0 where professor_id = new.professor_id;
		update acum_trabs set tot_acum_unid = 0 where professor_id = new.professor_id;
		update professors set flag = 1 where id = new.professor_id;



	select pont_base_trab,pont_base_efet,pont_base_rede,pont_base_unid into @pbt,@pbe,@pbr,@pbu from acum_trabs where professor_id = new.professor_id;
	select tot_acum_ant_trab,tot_acum_ant_efet,tot_acum_ant_rede,tot_acum_ant_unid into @tac,@tae,@tar,@tau from acum_trabs where professor_id = new.professor_id;


	select dias_trab into @dias_trab_ant from trabalhados where ano = (year(curdate()) -1) and professor_id = NEW.professor_id;
	select dias_trab into @dias_trab_at from trabalhados where ano = year(curdate()) and professor_id = NEW.professor_id;
	select dias_efetivos into @dias_efet_ant from trabalhados where ano = (year(curdate()) -1) and professor_id = NEW.professor_id;
	select dias_efetivos into @dias_efet_at from trabalhados where ano = year(curdate()) and professor_id = NEW.professor_id;
	select dias_rede into @dias_rede_ant from trabalhados where ano = (year(curdate()) -1) and professor_id = NEW.professor_id;
	select dias_rede into @dias_rede_at from trabalhados where ano = year(curdate()) and professor_id = NEW.professor_id;
	select dias_unidade into @dias_unid_ant from trabalhados where ano = (year(curdate()) -1) and professor_id = NEW.professor_id;
	select dias_unidade into @dias_unid_at from trabalhados where ano = year(curdate()) and professor_id = NEW.professor_id;

	SET @valor_trab = (@pbt * (@tac + @dias_trab_ant + @dias_trab_at));
	SET @valor_efet = (@pbe * (@tae + @dias_efet_ant + @dias_efet_at));
	SET @valor_rede = (@pbr * (@tar + @dias_rede_ant + @dias_rede_at));
	SET @valor_unid = (@pbu * (@tau + @dias_unid_ant + @dias_unid_at));
        set new.total = (@valor_trab + @valor_efet + @valor_rede);

	UPDATE professors SET total_trabalhado = (@valor_trab + @valor_efet + @valor_rede) where id = new.professor_id;
	END IF;


    END$$
